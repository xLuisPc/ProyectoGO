<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Clusters por G√©nero y Notas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background-color: #f9f9f9;
        }
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }
        canvas {
            max-width: 800px;
            margin: auto;
            display: block;
        }
        table {
            margin: 2rem auto;
            border-collapse: collapse;
            width: 90%;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #eee;
        }
        #formPrediccion {
            display: none;
            margin: 2rem auto;
            width: 80%;
            border: 1px solid #ccc;
            padding: 1rem;
            background: #f2f2f2;
        }
        #formPrediccion label {
            display: block;
            margin-top: 10px;
        }
        #resultadoPrediccion {
            text-align: center;
            margin-top: 1rem;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
<h1 style="text-align: center;">Clusters seg√∫n g√©nero y notas</h1>

<div class="controls">
    <div>
        <label for="genero">üé¨ G√©nero:</label>
        <select id="genero">
            <option value="genero_accion">Acci√≥n</option>
            <option value="genero_ciencia_ficcion">Ciencia Ficci√≥n</option>
            <option value="genero_comedia" selected>Comedia</option>
            <option value="genero_terror">Terror</option>
            <option value="genero_documental">Documental</option>
            <option value="genero_romance">Romance</option>
            <option value="genero_musicales">Musicales</option>
        </select>
    </div>
    <div>
        <label for="k">üî¢ Clusters:</label>
        <select id="k">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
    </div>
    <button onclick="document.getElementById('formPrediccion').style.display = 'block'">üîÆ Hacer predicci√≥n</button>
</div>

<canvas id="clusterChart" width="800" height="600"></canvas>

<h2 style="text-align:center">Resumen por Cluster</h2>
<table id="tablaResumen">
    <thead>
    <tr>
        <th>Cluster</th>
        <th>Cantidad</th>
        <th>Afinidad G√©nero</th>
        <th>POO</th>
        <th>CTD</th>
        <th>C√°lculo Multivariado</th>
        <th>Ing. Software</th>
        <th>Bases de Datos</th>
        <th>Control An√°logo</th>
        <th>Circuitos Digitales</th>
        <th>Promedio</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Formulario de predicci√≥n -->
<div id="formPrediccion">
    <h3>üîÆ Ingresar gustos para predecir</h3>

    <label for="carreraPrediccion">Carrera:</label>
    <select id="carreraPrediccion">
        <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
        <option value="Ingenier√≠a Electr√≥nica">Ingenier√≠a Electr√≥nica</option>
    </select>

    <label>Acci√≥n: <input type="number" min="0" max="10" id="genero_accion" required></label>
    <label>Ciencia Ficci√≥n: <input type="number" min="0" max="10" id="genero_ciencia_ficcion" required></label>
    <label>Comedia: <input type="number" min="0" max="10" id="genero_comedia" required></label>
    <label>Terror: <input type="number" min="0" max="10" id="genero_terror" required></label>
    <label>Documental: <input type="number" min="0" max="10" id="genero_documental" required></label>
    <label>Romance: <input type="number" min="0" max="10" id="genero_romance" required></label>
    <label>Musicales: <input type="number" min="0" max="10" id="genero_musicales" required></label>
    <br><br>
    <button onclick="predecirCluster()">Predecir</button>
    <button onclick="eliminarPrediccion()">‚ùå Eliminar predicci√≥n</button>
    <div id="resultadoPrediccion"></div>
</div>

<script>
    let chart = null;
    let ultimaPrediccion = null;

    async function cargarClusters() {
        const genero = document.getElementById("genero").value;
        const k = document.getElementById("k").value;
        const res = await fetch(`/api/estadisticas?genero=${genero}&k=${k}`);
        return await res.json();
    }

    function graficar(clusters, genero) {
        const colors = ['red', 'blue', 'green', 'purple', 'orange', 'cyan'];
        const datasets = clusters.map((cluster, i) => ({
            label: `Cluster ${i + 1}`,
            data: cluster.Personas.map(p => ({
                x: p[genero],
                y: p.promedio
            })),
            backgroundColor: colors[i % colors.length]
        }));

        if (chart) chart.destroy();

        chart = new Chart(document.getElementById("clusterChart"), {
            type: 'scatter',
            data: { datasets },
            options: {
                scales: {
                    x: {
                        title: { display: true, text: genero.replace("genero_", "").toUpperCase() },
                        beginAtZero: true
                    },
                    y: {
                        title: { display: true, text: "Promedio" },
                        beginAtZero: true,
                        max: 5
                    }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    function generarResumen(clusters, genero) {
        const tbody = document.querySelector("#tablaResumen tbody");
        tbody.innerHTML = "";

        clusters.forEach((cluster, i) => {
            const n = cluster.Personas.length || 1;
            const promedio = campo => cluster.Personas.reduce((sum, p) => sum + p[campo], 0) / n;

            const fila = document.createElement("tr");
            fila.innerHTML = `
          <td><b>${i + 1}</b></td>
          <td>${n}</td>
          <td>${promedio(genero).toFixed(2)}</td>
          <td>${promedio("poo").toFixed(2)}</td>
          <td>${promedio("ctd").toFixed(2)}</td>
          <td>${promedio("calculo_multivariado").toFixed(2)}</td>
          <td>${promedio("ingenieria_software").toFixed(2)}</td>
          <td>${promedio("bases_datos").toFixed(2)}</td>
          <td>${promedio("control_analogo").toFixed(2)}</td>
          <td>${promedio("circuitos_digitales").toFixed(2)}</td>
          <td>${promedio("promedio").toFixed(2)}</td>
        `;
            tbody.appendChild(fila);
        });
    }

    async function actualizar() {
        const genero = document.getElementById("genero").value;
        const clusters = await cargarClusters();
        graficar(clusters, genero);
        generarResumen(clusters, genero);

        // üîÑ Volver a predecir si hay datos guardados
        if (ultimaPrediccion) {
            await predecirConDatos(ultimaPrediccion);
        }
    }

    async function predecirCluster() {
        const datos = {
            carrera: document.getElementById("carreraPrediccion").value,
            genero_accion: parseInt(document.getElementById("genero_accion").value),
            genero_ciencia_ficcion: parseInt(document.getElementById("genero_ciencia_ficcion").value),
            genero_comedia: parseInt(document.getElementById("genero_comedia").value),
            genero_terror: parseInt(document.getElementById("genero_terror").value),
            genero_documental: parseInt(document.getElementById("genero_documental").value),
            genero_romance: parseInt(document.getElementById("genero_romance").value),
            genero_musicales: parseInt(document.getElementById("genero_musicales").value)
        };

        ultimaPrediccion = datos;
        await predecirConDatos(datos);
    }

    async function predecirConDatos(datos) {
        const res = await fetch("/api/prediccion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
        });

        const resultado = await res.json();
        const clusterID = resultado.cluster;
        const promedio = resultado.promedio;

        const generoSeleccionado = document.getElementById("genero").value;
        const afinidad = datos[generoSeleccionado];

        // Eliminar punto anterior
        chart.data.datasets = chart.data.datasets.filter(d => d.label !== "Predicci√≥n");

        // Agregar punto negro nuevo
        chart.data.datasets.push({
            label: "Predicci√≥n",
            data: [{ x: afinidad, y: promedio }],
            backgroundColor: "black",
            pointRadius: 6,
            pointHoverRadius: 8
        });

        chart.update();

        document.getElementById("resultadoPrediccion").innerText =
            `üîç Este perfil pertenece al Cluster ${clusterID + 1} | Estudiantes similares tienen un promedio de ${promedio.toFixed(2)}`;
    }

    function eliminarPrediccion() {
        ultimaPrediccion = null;
        chart.data.datasets = chart.data.datasets.filter(d => d.label !== "Predicci√≥n");
        chart.update();
        document.getElementById("resultadoPrediccion").innerText = "";
    }

    document.getElementById("genero").addEventListener("change", actualizar);
    document.getElementById("k").addEventListener("change", actualizar);
    window.addEventListener("DOMContentLoaded", actualizar);
</script>
</body>
</html>
